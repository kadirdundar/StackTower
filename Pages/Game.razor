@page "/"
@using StackTower.Services
@using StackTower.Models
@inject GameEngine Engine
@inject IJSRuntime JSRuntime

<div class="game-container" @onclick="HandleClick" style="@BackgroundStyle">
    <div class="score-board">
        <h1>Stack Tower</h1>
        <p>Score: @Engine.Score</p>
        <p class="best-score">Best: @BestScore</p>
    </div>

    @if (Engine.State == GameState.Ready)
    {
        <div class="game-over-overlay">
            <h2>Stack Tower</h2>
            <p>Stack blocks as high as you can!</p>
            <p>Best Score: @BestScore</p>
            <button class="btn btn-primary" @onclick="StartGame" @onclick:stopPropagation>Play Game</button>
        </div>
    }

    @if (Engine.State == GameState.GameOver)
    {
        <div class="game-over-overlay">
            <h2>Game Over</h2>
            <p>Score: @Engine.Score</p>
            <p>Best: @BestScore</p>
            <button class="btn btn-primary" @onclick="RestartGame" @onclick:stopPropagation>Play Again</button>
        </div>
    }

    <!-- Audio -->
    <audio id="fall-sound" src="sounds/fall.mp3"></audio>
    <audio id="scream-sound" src="sounds/scream.mp3"></audio>

    <div class="game-area" style="transform: translateY(@(CameraOffset.ToString(System.Globalization.CultureInfo.InvariantCulture))px)">
        <!-- Clouds (World Space) -->
        <div class="clouds" style="opacity: @(Engine.Score > 25 ? 0 : 1)">
            <!-- Clouds at different world heights -->
            <img src="images/cloud.png" class="cloud" style="bottom: 400px; width: 150px; animation-duration: 45s; left: -150px;" />
            <img src="images/cloud.png" class="cloud" style="bottom: 600px; width: 100px; animation-duration: 35s; animation-delay: -10s; left: -100px;" />
            <img src="images/cloud.png" class="cloud" style="bottom: 800px; width: 180px; animation-duration: 55s; animation-delay: -25s; left: -120px;" />
            <img src="images/cloud.png" class="cloud" style="bottom: 200px; width: 120px; animation-duration: 40s; animation-delay: -5s; left: -120px;" />
        </div>

        @foreach (var block in Engine.Stack)
        {
            <div class="block" style="left: @(block.X.ToString(System.Globalization.CultureInfo.InvariantCulture))px; width: @(block.Width.ToString(System.Globalization.CultureInfo.InvariantCulture))px; bottom: @(block.Y.ToString(System.Globalization.CultureInfo.InvariantCulture))px; background-color: @block.Color;"></div>
        }
        
        @foreach (var debris in Engine.Debris)
        {
            <div class="block" style="left: @(debris.X.ToString(System.Globalization.CultureInfo.InvariantCulture))px; width: @(debris.Width.ToString(System.Globalization.CultureInfo.InvariantCulture))px; bottom: @(debris.Y.ToString(System.Globalization.CultureInfo.InvariantCulture))px; background-color: @debris.Color; transform: rotate(@(debris.Rotation)deg);"></div>
        }
        
        @if (Engine.State != GameState.GameOver && Engine.State != GameState.Ready && Engine.CurrentBlock != null)
        {
            <!-- Rope -->
            @if (Engine.State == GameState.Swinging)
            {
               <div class="rope" style="left: 299px; bottom: @(RopeBottom.ToString(System.Globalization.CultureInfo.InvariantCulture))px; height: 200px; transform: rotate(@((-1 * Engine.CurrentBlock.Rotation).ToString(System.Globalization.CultureInfo.InvariantCulture))deg); transform-origin: top center;"></div>
            }

            <div class="block current" style="
                left: @(Engine.CurrentBlock.X.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                width: @(Engine.CurrentBlock.Width.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                bottom: @(Engine.CurrentBlock.Y.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                background-color: @Engine.CurrentBlock.Color;
                transform: rotate(@((-1 * Engine.CurrentBlock.Rotation).ToString(System.Globalization.CultureInfo.InvariantCulture))deg);
                transform-origin: top center;
            "></div>
        }
    </div>
</div>

@code {
    private DotNetObjectReference<Game>? dotNetHelper;
    private double CameraOffset => Math.Max(0, (Engine.Stack.Count * 40) - 200);
    private double RopeBottom => (Engine.Stack.Count * 40) + 100;
    private int BestScore { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("Game initializing...");
            dotNetHelper = DotNetObjectReference.Create(this);
            Engine.OnStateChanged += StateHasChanged;
            Engine.OnBlockLanded += PlayFallSound;
            Engine.OnGameOver += HandleGameOver;
            await JSRuntime.InvokeVoidAsync("gameLoop.start", dotNetHelper);
            
            // Load Best Score
            BestScore = await JSRuntime.InvokeAsync<int>("gameLoop.getHighScore");
            StateHasChanged();
        }
    }

    private void PlayFallSound()
    {
        _ = JSRuntime.InvokeVoidAsync("gameLoop.playSound", "fall-sound");
    }

    private async void HandleGameOver()
    {
        // Play Sound
        await JSRuntime.InvokeVoidAsync("gameLoop.playSound", "scream-sound");
        
        // Check Best Score
        if (Engine.Score > BestScore)
        {
            BestScore = Engine.Score;
            await JSRuntime.InvokeVoidAsync("gameLoop.saveHighScore", BestScore);
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void GameLoop()
    {
        Engine.Tick();
        StateHasChanged();
    }

    private void HandleClick()
    {
        if (Engine.State == GameState.Swinging)
        {
            Engine.DropBlock();
        }
    }

    private void StartGame()
    {
        Engine.StartGame();
    }

    private void RestartGame(MouseEventArgs e)
    {
        Engine.ResetGame();
        Engine.StartGame(); // Skip Start Screen for "Play Again"
    }
    
    private string BackgroundStyle
    {
        get
        {
            if (Engine.Score < 10) return "background-color: #3498db;";
            if (Engine.Score < 20) return "background-color: #9b59b6;";
            if (Engine.Score < 30) return "background-color: #2c3e50;";
            return "background-color: #1a1a2e;";
        }
    }
    
    public void Dispose()
    {
        Engine.OnStateChanged -= StateHasChanged;
        Engine.OnBlockLanded -= PlayFallSound;
        Engine.OnGameOver -= HandleGameOver;
        dotNetHelper?.Dispose();
    }
}
