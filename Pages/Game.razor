@page "/"
@using StackTower.Services
@using StackTower.Models
@inject GameEngine Engine
@inject IJSRuntime JSRuntime

<div class="game-container" @onclick="HandleClick" style="@BackgroundStyle">
    <div class="score-board">
        <h1>Stack Tower</h1>
        <p>Score: @Engine.Score</p>
        <p class="best-score">Best: @BestScore</p>
    </div>

    @if (Engine.State == GameState.Ready)
    {
        <div class="game-over-overlay">
            <h2>Stack Tower</h2>
            <p>Stack blocks as high as you can!</p>
            <p>Best Score: @BestScore</p>
            <button class="btn btn-primary" @onclick="StartGame" @onclick:stopPropagation>Play Game</button>
        </div>
    }

    @if (Engine.State == GameState.GameOver)
    {
        <div class="game-over-overlay">
            <h2>Game Over</h2>
            <p>Score: @Engine.Score</p>
            <p>Best: @BestScore</p>
            <button class="btn btn-primary" @onclick="RestartGame" @onclick:stopPropagation>Play Again</button>
        </div>
    }

    <!-- Audio -->
    <audio id="fall-sound" src="sounds/fall.mp3"></audio>
    <audio id="scream-sound" src="sounds/scream.mp3"></audio>

    <div class="game-area" style="transform: translateY(@(CameraOffset.ToString(System.Globalization.CultureInfo.InvariantCulture))px)">
        <BackgroundClouds Score="Engine.Score" />

        <LandedStack Stack="Engine.Stack" />
        
        @foreach (var debris in Engine.Debris)
        {
            <div @key="debris" class="block" style="left: @(debris.X.ToString(System.Globalization.CultureInfo.InvariantCulture))px; width: @(debris.Width.ToString(System.Globalization.CultureInfo.InvariantCulture))px; bottom: @(debris.Y.ToString(System.Globalization.CultureInfo.InvariantCulture))px; background-color: @debris.Color; transform: rotate(@(debris.Rotation)deg);"></div>
        }
        
        @if (Engine.State != GameState.GameOver && Engine.State != GameState.Ready && Engine.CurrentBlock != null)
        {
            <!-- Rope -->
            @if (Engine.State == GameState.Swinging)
            {
               <div class="rope" style="left: 299px; bottom: @(RopeBottom.ToString(System.Globalization.CultureInfo.InvariantCulture))px; height: @(Engine.RopeLength.ToString(System.Globalization.CultureInfo.InvariantCulture))px; transform: rotate(@((-1 * Engine.CurrentBlock.Rotation).ToString(System.Globalization.CultureInfo.InvariantCulture))deg); transform-origin: top center;"></div>
            }

            <div class="block current" style="
                left: @(Engine.CurrentBlock.X.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                width: @(Engine.CurrentBlock.Width.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                bottom: @(Engine.CurrentBlock.Y.ToString(System.Globalization.CultureInfo.InvariantCulture))px; 
                background-color: @Engine.CurrentBlock.Color;
                transform: rotate(@((-1 * Engine.CurrentBlock.Rotation).ToString(System.Globalization.CultureInfo.InvariantCulture))deg);
                transform-origin: top center;
            "></div>
        }
    </div>
</div>

@code {
    private DotNetObjectReference<Game>? dotNetHelper;
    private double ContainerHeight { get; set; } = 800; // Default
    
    // Revert to standard camera following the stack
    private double CameraOffset => Math.Max(0, (Engine.Stack.Count * 40) - 200);
    
    private double RopeBottom => (Engine.Stack.Count * 40) + 100;
    private int BestScore { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Console.WriteLine("Game initializing...");
            dotNetHelper = DotNetObjectReference.Create(this);
            Engine.OnStateChanged += StateHasChanged;
            Engine.OnBlockLanded += PlayFallSound;
            Engine.OnGameOver += HandleGameOver;
            await JSRuntime.InvokeVoidAsync("gameLoop.start", dotNetHelper);
            
            // Get Container Height and Set Rope Length
            try 
            {
               int height = await JSRuntime.InvokeAsync<int>("gameLoop.getContainerHeight");
               if (height > 0) 
               {
                   ContainerHeight = height;
                   // Set Rope Length so pivot is near top
                   // We want PivotY when CameraOffset is 0 (start) to be roughly ContainerHeight - 100
                   // PivotY = (StackCount*40) + RopeLength + 100
                   // StackCount=1 => 40 + RopeLength + 100 = RopeLength + 140
                   // RopeLength + 140 = ContainerHeight - 50 margin
                   // RopeLength = ContainerHeight - 190
                   Engine.RopeLength = ContainerHeight - 200; 
               }
            }
            catch (Exception ex)
            {
                Console.WriteLine("Error getting height: " + ex.Message);
            }
            
            // Load Best Score
            BestScore = await JSRuntime.InvokeAsync<int>("gameLoop.getHighScore");
            StateHasChanged();
        }
    }

    private void PlayFallSound()
    {
        _ = JSRuntime.InvokeVoidAsync("gameLoop.playSound", "fall-sound");
    }

    private async void HandleGameOver()
    {
        // Play Sound
        await JSRuntime.InvokeVoidAsync("gameLoop.playSound", "scream-sound");
        
        // Check Best Score
        if (Engine.Score > BestScore)
        {
            BestScore = Engine.Score;
            await JSRuntime.InvokeVoidAsync("gameLoop.saveHighScore", BestScore);
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void GameLoop()
    {
        Engine.Tick();
        StateHasChanged();
    }

    private void HandleClick()
    {
        if (Engine.State == GameState.Swinging)
        {
            Engine.DropBlock();
        }
    }

    private void StartGame()
    {
        Engine.StartGame();
    }

    private void RestartGame(MouseEventArgs e)
    {
        Engine.ResetGame();
        Engine.StartGame(); // Skip Start Screen for "Play Again"
    }
    
    private string BackgroundStyle
    {
        get
        {
            if (Engine.Score < 10) return "background-color: #3498db;";
            if (Engine.Score < 20) return "background-color: #9b59b6;";
            if (Engine.Score < 30) return "background-color: #2c3e50;";
            return "background-color: #1a1a2e;";
        }
    }
    
    public void Dispose()
    {
        Engine.OnStateChanged -= StateHasChanged;
        Engine.OnBlockLanded -= PlayFallSound;
        Engine.OnGameOver -= HandleGameOver;
        dotNetHelper?.Dispose();
    }
}
